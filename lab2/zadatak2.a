BVJ    EQU 0FFFFFFFC

CTCR   EQU 0FFFF0000
CTLR   EQU 0FFFF0004
CTSTAT EQU 0FFFF0008
CTEND  EQU 0FFFF000C

DMA_SRC   EQU 0FFFF1000
DMA_DEST  EQU 0FFFF1004
DMA_SIZE  EQU 0FFFF1008
DMA_CTRL  EQU 0FFFF100C
DMA_START EQU 0FFFF1010
DMA_BS    EQU 0FFFF1014

    ORG 0
    MOVE 10000, R7
    JR GLAVNI

    ORG 0C
    PUSH R1
    PUSH R0
    MOVE SR, R0
    PUSH R0
    STORE R0, (DMA_BS)

    LOAD R0, (ADRESA)
    ADD R0, 24, R0
    MOVE -1, R1
    STORE R1, (R0)
    ADD R0, 4, R0
    STORE R0, (ADRESA)

    LOAD R1, (BLOKOVI)
    ADD R1, 1, R1
    STORE R1, (BLOKOVI)

    MOVE 1, R1
    STORE R1, (ZAVRSENO)

    POP R0
    MOVE R0, SR
    POP R0
    POP R1
    RETN

GLAVNI
    MOVE %D 1000, R0
    STORE R0, (CTLR)
    MOVE %B 001, R0
    STORE R0, (CTCR)

PETLJA
    LOAD R0, (BLOKOVI)
    CMP R0, 5
    JR_EQ KRAJ

    LOAD R0, (CTSTAT)
    CMP R0, 0
    JR_EQ PETLJA
SPREMNA
    STORE R0, (CTSTAT)

    MOVE BVJ, R0
    STORE R0, (DMA_SRC)
    LOAD R0, (ADRESA)
    STORE R0, (DMA_DEST)
    MOVE 9, R0
    STORE R0, (DMA_SIZE)
    MOVE %B 0111, R0
    STORE R0, (DMA_CTRL)

    STORE R0, (DMA_START)

CEKAJ
    LOAD R0, (ZAVRSENO)
    CMP R0, 0
    JR_EQ CEKAJ
    MOVE 0, R0
    STORE R0, (ZAVRSENO)

    STORE R0, (CTEND)

    JR PETLJA

KRAJ
    MOVE 0, R0
    STORE R0, (CTCR)
    HALT

BLOKOVI DW 0
ADRESA DW 1000
ZAVRSENO DW 0
